var imageLoader=document.getElementById("imageLoader");imageLoader.addEventListener("change",loadImage,!1);var renderableHeight,renderableWidth,start,startX,startY,lumB,imageObj,canvas=document.getElementById("imageCanvas"),ctx=canvas.getContext("2d"),topDetectedColours=[],adjusted=[],oCanvas=document.getElementById("oCanvas"),oCtx=oCanvas.getContext("2d"),oWidth=oCanvas.width,oHeight=oCanvas.height,okToMove=!1,myopacity=0,dMaxSlider=80,dMinSlider=15,cSlider=3,impairment=!1,saturation=!0,rect={x:oWidth/3,y:oHeight/3,width:oWidth/3,height:oHeight/3};oCanvas.onmousedown=mouseDown,oCanvas.onmouseup=mouseUp,oCanvas.onmousemove=mouseMove;var pick=new ColourCircle(document.querySelector(".color-space"));function toggleImpairment(){impairment?(impairment=!1,document.getElementById("impairToggle").innerHTML="Off"):(impairment=!0,document.getElementById("impairToggle").innerHTML="On"),imageObj&&imageHistogram()}function toggleSaturation(){for(saturation?(saturation=!1,pick=new ColourCircle(document.querySelector(".color-space"))):(saturation=!0,pick=new ColourCircle(document.querySelector(".color-space"))),i=1;i<topDetectedColours.length&&!(i>5);i++)pick.plotRgb(topDetectedColours[i].r,topDetectedColours[i].g,topDetectedColours[i].b,i)}function reDraw(){oCtx.clearRect(0,0,oWidth,oHeight),oCtx.beginPath(),oCtx.lineWidth=8,oCtx.strokeStyle="white",oCtx.strokeRect(rect.x,rect.y,rect.width,rect.height),oCtx.closePath(),oCtx.stroke(),oCtx.beginPath(),oCtx.lineWidth=4,oCtx.strokeStyle="black",oCtx.strokeRect(rect.x,rect.y,rect.width,rect.height),oCtx.closePath(),oCtx.stroke()}function mouseDown(e){e.preventDefault(),e.stopPropagation();var t=parseInt(e.clientX),o=parseInt(e.clientY);okToMove=!0,startX=t,startY=o}function mouseUp(e){e.preventDefault(),e.stopPropagation(),okToMove=!1,imageHistogram()}function mouseMove(e){if(okToMove){e.preventDefault(),e.stopPropagation();var t=parseInt(e.clientX),o=parseInt(e.clientY),a=!1,r=!1,i=t-startX,n=o-startY;(rect.x<=0||rect.x>=oWidth-oWidth/3)&&(a=!0),(rect.y<=0||rect.y>=oHeight-oHeight/3)&&(r=!0),okToMove&&(a?(rect.x<=0&&(rect.x=1),rect.x>=oWidth-oWidth/3&&(rect.x=rect.x-1),a=!1):rect.x+=i,r?(rect.y<=0&&(rect.y=1),rect.y>=oHeight-oHeight/3&&(rect.y=rect.y-1),r=!1):rect.y+=n),reDraw(),startX=t,startY=o}}function loadImage(e){var t=new FileReader;t.onload=function(e){(imageObj=new Image).onload=function(){var e,t,o=imageObj.width/imageObj.height,a=canvas.width/canvas.height;o<a?(renderableHeight=canvas.height,renderableWidth=imageObj.width*(renderableHeight/imageObj.height),e=(canvas.width-renderableWidth)/2,t=0):o>a?(renderableWidth=canvas.width,renderableHeight=imageObj.height*(renderableWidth/imageObj.width),e=0,t=(canvas.height-renderableHeight)/2):(renderableHeight=canvas.height,renderableWidth=canvas.width,e=0,t=0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(imageObj,e,t,renderableWidth,renderableHeight),document.getElementById("design").setAttribute("style","display: none;"),fadeOpacity(),imageHistogram()},imageObj.src=e.target.result},t.readAsDataURL(e.target.files[0])}function fadeOpacity(){document.getElementById("dl").style.display="block",myopacity<1&&(myopacity+=.075,setTimeout(function(){fadeOpacity()},100)),document.getElementById("dl").style.opacity=myopacity}function imageHistogram(){start=(new Date).valueOf(),topDetectedColours=[];for(var e,t,o,a,r=[],i=canvas.width,n=canvas.height,d=ctx.getImageData(rect.x,rect.y,i/3,n/3),l=0;l<d.data.length;l+=16)e=d.data[l],t=d.data[l+1],o=d.data[l+2],d.data[l+3],-1==r.indexOf(e+"."+t+"."+o)&&r.push(e+"."+t+"."+o),a=r.indexOf(e+"."+t+"."+o),topDetectedColours[a]?topDetectedColours[a].v=topDetectedColours[a].v+1:topDetectedColours[a]={v:1,r:e,b:o,g:t};topDetectedColours=trimToDeltaDiffFG(topDetectedColours=trimToDeltaDiff(topDetectedColours=topColoursAddDelta(topDetectedColours=topDetectedColours.sort(function(e,t){return t.v-e.v})))),changeConstrastImage(d)}function changeConstrastImage(e){var t,o,a,r,i,n,d=[],l=rgb2lab(topDetectedColours[0].r,topDetectedColours[0].g,topDetectedColours[0].b);lumB=getRelLuminance(topDetectedColours[0].r,topDetectedColours[0].g,topDetectedColours[0].b),adjusted=[];for(var s=0;s<e.data.length;s+=4)if(t=e.data[s],o=e.data[s+1],a=e.data[s+2],r=e.data[s+3],t+","+a+","+o!=topDetectedColours[0].r+","+topDetectedColours[0].b+","+topDetectedColours[0].g){var c=rgb2lab(t,o,a);if(n=getContrast(i=getRelLuminance(t,o,a),lumB),ciede2000(c,l)>dMinSlider&&ciede2000(c,l)<dMaxSlider&&cSlider>n){if(impairment)u=impairmentLightness(cSlider,c,lumB,t,o,a);else var u=adjustLightness(cSlider,c,lumB,t,o,a);i=getRelLuminance(u[0],u[1],u[2]);var g=[Math.round(u[0]),Math.round(u[1]),Math.round(u[2]),r];e.data[s]=g[0],e.data[s+1]=g[1],e.data[s+2]=g[2],e.data[s+3]=g[3],-1==d.indexOf(t+"."+o+"."+a)&&d.push(t+"."+o+"."+a),index=d.indexOf(t+"."+o+"."+a),adjusted[t+"."+o+"."+a]?adjusted[t+"."+o+"."+a].v=adjusted[t+"."+o+"."+a].v+1:adjusted[t+"."+o+"."+a]={v:1,r:g[0],g:g[1],b:g[2],c:Math.round(10*getContrast(i,lumB))/10}}}drawAnalysis(e)}function drawAnalysis(e){oCtx.putImageData(e,rect.x,rect.y);var t,o=50,a=0,r="",n="",d="<div style='background-color: "+("rgb("+topDetectedColours[0].r+","+topDetectedColours[0].g+","+topDetectedColours[0].b+")")+"; height:50px;' onclick='copyRGB(this)' onmouseover='showDetails(this,0)' onmouseout='hideDetails(this)'>BG</div>";for(document.getElementById("message").innerHTML="",pick=new ColourCircle(document.querySelector(".color-space")),i=1;i<topDetectedColours.length&&i<=5;i++){o-=.15*o,pick.plotRgb(topDetectedColours[i].r,topDetectedColours[i].g,topDetectedColours[i].b,i),t=topDetectedColours[i].r+","+topDetectedColours[i].g+","+topDetectedColours[i].b;var l=topDetectedColours[i].r+"."+topDetectedColours[i].g+"."+topDetectedColours[i].b;d+="<div class='detected' style='background-color: rgb("+t+"); height:"+o+"px' onclick='copyRGB(this)' onmouseover='showDetails(this,"+i+")' onmouseout='hideDetails(this)'>"+i+"</div>",null!=adjusted[l]&&(r+="<div class ='changed' style='background-color: rgb("+t+");' onclick='copyRGB(this)' onmouseover='showDetails(this,"+i+")' onmouseout='hideDetails(this)'>"+i+"</div>",n+="<div class ='changed' style='background-color: rgb("+adjusted[l].r+","+adjusted[l].g+","+adjusted[l].b+");' onclick='copyRGB(this)' onmouseover='showDetails(this,"+i+",a,b)' onmouseout='hideDetails(this)'>"+i+"</div>",a++)}document.getElementById("topColours").innerHTML=d,document.getElementById("histogram").innerHTML=r,document.getElementById("suggestion").innerHTML=n,document.getElementById("corrections").style.height=38*a+"px",""===n&&(document.getElementById("message").innerHTML="<p>Contrast requirement is met or no colours within ΔE* range</p>");var s=(new Date).valueOf();document.getElementById("toast").innerHTML="<p>"+(s-start)+" ms</p>",setTimeout("document.getElementById('toast').innerHTML = ''",1300)}function copyRGB(e){var t=getComputedStyle(e).getPropertyValue("background-color");document.getElementById("toast").innerHTML="<p>"+t+" <b>COPIED</b>!</p>";var o=document.createElement("input");document.body.appendChild(o),o.setAttribute("value",t),o.select(),document.execCommand("copy"),document.body.removeChild(o),setTimeout("document.getElementById('toast').innerHTML = ''",1300)}function showDetails(e,t,o,a){var r=getComputedStyle(e).getPropertyValue("background-color"),i="rgb("+topDetectedColours[0].r+", "+topDetectedColours[0].g+", "+topDetectedColours[0].b+")";if(document.getElementById("details").style.display="block",document.getElementById("details").style.zIndex="99",document.getElementById("details").style.background=i,t>0){var n=getRelLuminance(topDetectedColours[t].r,topDetectedColours[t].g,topDetectedColours[t].b),d=topDetectedColours[t].dE.toFixed(2);if(o){var l=topDetectedColours[t].r+"."+topDetectedColours[t].g+"."+topDetectedColours[t].b;d=(d=ciede2000(rgb2lab(adjusted[l].r,adjusted[l].g,adjusted[l].b),rgb2lab(topDetectedColours[0].r,topDetectedColours[0].g,topDetectedColours[0].b))).toFixed(2),n=getRelLuminance(adjusted[l].r,adjusted[l].g,adjusted[l].b)}l=(l=getContrast(n,lumB)).toFixed(2);var s=topDetectedColours[t].v;s=t>1?s/topDetectedColours[1].v*100:100;var c=document.getElementById("typeSelect").value;e=document.getElementById("details");1==c?l>=4.5&&l<7?e.classList.add("aa"):l>=7&&e.classList.add("aaa"):2==c?l>=3&&l<4.5?e.classList.add("aa"):l>=4.5&&e.classList.add("aaa"):3==c&&(l>=3&&l<4.5?e.classList.add("aa"):l>=4.5&&e.classList.add("aaa")),l<cSlider&&(l+=a&&!impairment?" (maxed out)":" (!)"),document.getElementById("details").innerHTML+="<div class='info'><p> Colour: "+r+"</p><p>Brightness: "+n.toFixed(2)+"</p><p>Contrast: "+l+"</p><p> ΔE*: "+d+"</p><p>Instances: "+topDetectedColours[t].v+"</p><p>this/top FG: "+s.toFixed(2)+"%</p></div>",document.getElementById("details").innerHTML+="<div class='readThis' style='"+i+";'><p style='font-size:8px;color:"+r+"'>Can you read this?</p><p style='color:"+r+"'>Can you read this?</p><p style='font-size:30px;color:"+r+"'>Can you read this?</p><p style='font-size:40px;color:"+r+"'>Can you read this?</p></div>"}else document.getElementById("details").innerHTML="<div class='info'><p><b>Calculated background colour:</b></p><p> Colour: "+r+"</p><p>Brightness: "+lumB.toFixed(2)+"</p><p>Instances: "+topDetectedColours[t].v+"</p></div>"}function hideDetails(e){document.getElementById("details").style.display="none",document.getElementById("details").style.zIndex="-1",document.getElementById("details").innerHTML="",document.getElementById("details").className=""}function download(){var e=document.getElementById("download"),t=document.getElementById("oCanvas").toDataURL("image/png").replace("image/png","image/octet-stream");e.setAttribute("href",t)}function topColoursAddDelta(e){var t=rgb2lab(e[0].r,e[0].g,e[0].b);for(i=1;i<e.length;i++)lab=rgb2lab(e[i].r,e[i].g,e[i].b),e[i].dE=ciede2000(t,lab);return e}function trimToDeltaDiff(e){var t=[];for(t[0]=topDetectedColours[0],i=1;i<e.length;i++)e[i].dE>=3&&t.push(topDetectedColours[i]);return t}function trimToDeltaDiffFG(e){var t,o,a,r=[];r[0]=e[0],null!=e[1]&&(r.push(e[1]),t=rgb2lab(e[1].r,e[1].g,e[1].b),e[1].v,a=rgb2lab(r[0].r,r[0].g,r[0].b));e:for(i=1;i+1<e.length;i++)if(o=rgb2lab(e[i].r,e[i].g,e[i].b),ciede2000(o,t)>dMinSlider&&ciede2000(o,a)<dMaxSlider&&ciede2000(o,a)>dMinSlider){for(j=0;j<r.length;j++)if(ciede2000(o,rgb2lab(r[j].r,r[j].g,r[j].b))<dMinSlider)continue e;r.push(e[i])}return r=r.slice(0,6)}function getContrast(e,t){return(Math.max(e,t)+.05)/(Math.min(e,t)+.05)}function getRelLuminance(e,t,o){var a=[e,t,o].map(function(e){return(e/=255)<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)});return.2126*a[0]+.7152*a[1]+.0722*a[2]}function adjustLightness(e,t,o,a,r,i){for(var n,d,l,s,c=1,u=t[0];u>=0;){if(getContrast(d=getRelLuminance((n=lab2rgb([u,t[1],t[2]]))[0],n[1],n[2]),o)>=e)return n;l=d,u-=.5*c,c++}for(u=t[0],c=1;u<=100;){if(getContrast(d=getRelLuminance((n=lab2rgb([u,t[1],t[2]]))[0],n[1],n[2]),o)>=e)return n;s=d,u+=.5*c,c++}return Math.abs(s-o)>Math.abs(l-o)?[255,255,255]:[0,0,0]}function impairmentLightness(e,t,o,a,r,i){for(var n,d,l,s,c=1,u=t[0];u>=0;){if(1.7*getContrast(d=getRelLuminance((n=lab2rgb([u,t[1],t[2]]))[0],n[1],n[2]),o)>=e)return n;l=d,u-=.5*c,c++}for(u=t[0],c=1;u<=100;){if(1.7*getContrast(d=getRelLuminance((n=lab2rgb([u,t[1],t[2]]))[0],n[1],n[2]),o)>=e)return n;s=d,u+=.5*c,c++}return Math.abs(s-o)>Math.abs(l-o)?[255,255,255]:[0,0,0]}function ColourCircle(e,t,o,a){document.getElementById("cs").innerHTML="",this.element=e,this.init=function(){var t=document.createElement("canvas");t.height=200,t.width=200,this.canvas=t,this.renderColorMap(),e.appendChild(t)},this.renderColorMap=function(){var e,t=this.canvas,o=t.getContext("2d"),a=t.width/2;Math.PI;o.clearRect(0,0,t.width,t.height);cy=a;var r,i=t.width/2,n=t.height/2;e=saturation?"100%":"0%";for(var d=0;d<360;d+=1){var l=(d-2)*Math.PI/180,s=d*Math.PI/180,c=i+a*Math.cos(s),u=n+a*Math.sin(s);(r=o.createLinearGradient(i,n,c,u)).addColorStop(0,"hsl("+d+", "+e+", 100%)"),r.addColorStop(.1,"hsl("+d+", "+e+", 90%)"),r.addColorStop(.2,"hsl("+d+", "+e+", 80%)"),r.addColorStop(.3,"hsl("+d+", "+e+", 70%)"),r.addColorStop(.4,"hsl("+d+", "+e+", 60%)"),r.addColorStop(.5,"hsl("+d+", "+e+", 50%)"),r.addColorStop(.6,"hsl("+d+", "+e+", 40%)"),r.addColorStop(.7,"hsl("+d+", "+e+", 30%)"),r.addColorStop(.8,"hsl("+d+", "+e+", 20%)"),r.addColorStop(1,"hsl("+d+", "+e+", 5%)"),o.beginPath(),o.arc(i,n,.5*a,l,s,!1),o.lineWidth=a,o.strokeStyle=r,o.stroke()}},this.plotRgb=function(e,t,o,a){var r=this.canvas,i=r.getContext("2d"),n=rgbToHsl(e,t,o),d=[e,t,o],l=2*n[0]*Math.PI,s=r.width/2,c=(1-n[2])*s,u=c*Math.cos(l)+s,g=c*Math.sin(l)+s;if(saturation||(d=hslToRgb(n[0],0,n[2])),i.fillStyle="rgb("+d[0]+","+d[1]+","+d[2]+")",i.beginPath(),i.arc(u,g,6,0,2*Math.PI),i.strokeStyle="rgb(0,0,0)",i.lineWidth=1,i.closePath(),i.fill(),i.font="10pt Calibri",i.textAlign="center",i.fillStyle="rgb(0,0,0)",i.fillText(a,u,g+16),i.stroke(),null!=adjusted[e+"."+t+"."+o]){l=2*(n=rgbToHsl(adjusted[e+"."+t+"."+o].r,adjusted[e+"."+t+"."+o].g,adjusted[e+"."+t+"."+o].b))[0]*Math.PI;var h=(c=(1-n[2])*s)*Math.cos(l)+s,m=c*Math.sin(l)+s;d=saturation?hslToRgb(n[0],n[1],n[2]):hslToRgb(n[0],0,n[2]),i.fillStyle="rgb("+d[0]+", "+d[1]+", "+d[2]+")",i.beginPath(),i.arc(h,m,6,0,2*Math.PI),i.strokeStyle="rgb(0,0,0)",i.lineWidth=1,i.closePath(),i.moveTo(u,g),i.lineTo(h,m),i.fill(),i.stroke();var p=2*Math.PI,C=h-u,b=m-g,v=(Math.atan2(b,C)+p)%p;i.save(),i.lineWidth=1,i.beginPath(),i.translate(h,m),i.rotate(v),i.moveTo(0,0),i.lineTo(-8,4),i.lineTo(-8,-4),i.closePath(),i.fillStyle="rgb(0,0,0)",i.fill(),i.restore()}},this.init()}reDraw();